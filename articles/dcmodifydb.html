<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="dcmodifydb">
<title>dcmodifydb • dcmodifydb</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="dcmodifydb">
<meta property="og:description" content="dcmodifydb">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">dcmodifydb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.9001</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/dcmodifydb.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/scenarios.html">Correction scenarios</a>
    <a class="dropdown-item" href="../articles/syntax.html">Modification syntax</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/data-cleaning/dcmodifydb/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="dcmodifydb_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>dcmodifydb</h1>
            <h3 data-toc-skip class="subtitle">Documented reproducible data correction on a database</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/data-cleaning/dcmodifydb/blob/HEAD/vignettes/dcmodifydb.Rmd" class="external-link"><code>vignettes/dcmodifydb.Rmd</code></a></small>
      <div class="d-none name"><code>dcmodifydb.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The goal of dcmodifydb is to apply modification rules specified with <code>dcmodify</code> on a database table, allowing for documented, reproducable data cleaning adjustments in a database.</p>
<p><code>dcmodify</code> separates <strong>intent</strong> from <strong>execution</strong>: a user specifies the <em>what</em> , <em>why</em> and <em>how</em> of an automatic data change and uses <code>dcmodifydb</code> to execute them on a <code>tbl</code> database table.</p>
<p><code>dcmodidfydb</code> is optimized and restricted to database tables that can be accessed within R through <code>DBI</code>. It uses the <code>dbplyr</code> package to translate the data correction rules in R syntax into SQL syntax. The advantage of this approach is that all data correction is done within the database, which may be a requirement of your organisation or because the data table is simply too large to be held in memory. A disadvantage is that not all R statements can be translated into SQL statement, so <code>dcmodifydb</code> is more restricted than <code>dcmodify</code> which can use the full R potential. Nonetheless <code>dcmodifydb</code> may be sufficient and efficient for many use cases.</p>
<p>For common error scenario’s see <code><a href="../articles/scenarios.html">vignette("scenarios", package="dcmodifydb")</a></code>. For the supported syntax for specifying rules see <code><a href="../articles/syntax.html">vignette("syntax", package="dcmodifydb")</a></code>.</p>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p><code>dcmodifydb</code> can be installed with</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"dcmodifydb"</span><span class="op">)</span></code></pre></div>
<p>and loaded with:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/data-cleaning/dcmodify" class="external-link">dcmodify</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/data-cleaning/dcmodifydb" class="external-link">dcmodifydb</a></span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h3>
<p><code>dcmodifydb</code> works on a database table, so we need a connection to a table within a database.</p>
<p>We set up a database table with sqlite using the <code>person</code> data set, but for your use case you should connect to your database.</p>
<table class="table">
<thead><tr class="header">
<th align="right">income</th>
<th align="right">age</th>
<th align="left">gender</th>
<th align="right">year</th>
<th align="left">smokes</th>
<th align="right">cigarettes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">2000</td>
<td align="right">12</td>
<td align="left">M</td>
<td align="right">2020</td>
<td align="left">no</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="right">2010</td>
<td align="right">14</td>
<td align="left">f</td>
<td align="right">2019</td>
<td align="left">yes</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="right">2010</td>
<td align="right">25</td>
<td align="left">v</td>
<td align="right">19</td>
<td align="left">no</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">":memory:"</span><span class="op">)</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">person</span><span class="op">)</span></code></pre></div>
<p>We now retrieve a handle to the person table using <code>dplyr</code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">person_tbl</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"person"</span><span class="op">)</span>
<span class="va">person_tbl</span>
<span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;person&gt; [?? x 6]</span></span>
<span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.37.2 [:memory:]</span></span>
<span class="co">#&gt;   income   age gender  year smokes cigarettes</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>   <span style="text-decoration: underline;">2</span>000    12 M       <span style="text-decoration: underline;">2</span>020 no             10</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>   <span style="text-decoration: underline;">2</span>010    14 f       <span style="text-decoration: underline;">2</span>019 yes             4</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>   <span style="text-decoration: underline;">2</span>010    25 v         19 no             <span style="color: #BB0000;">NA</span></span></code></pre></div>
<p>The person dataset clearly contains some errors that can be corrected. We specify the corrections using modifier rules and apply them directly with the function<code>modify_so</code>.</p>
<p>First we correct that children can not have an income and that year must be a long year.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/data-cleaning/dcmodify" class="external-link">dcmodify</a></span><span class="op">)</span> <span class="co"># needed for modifying rules</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/data-cleaning/dcmodifydb" class="external-link">dcmodifydb</a></span><span class="op">)</span> <span class="co"># needed to translate the rules</span>
<span class="fu"><a href="https://rdrr.io/pkg/dcmodify/man/modify_so.html" class="external-link">modify_so</a></span><span class="op">(</span> <span class="va">person_tbl</span>
         , <span class="kw">if</span> <span class="op">(</span><span class="va">age</span> <span class="op">&lt;</span> <span class="fl">16</span><span class="op">)</span> <span class="va">income</span> <span class="op">=</span> <span class="fl">0</span>
         , <span class="kw">if</span> <span class="op">(</span><span class="va">year</span> <span class="op">&lt;</span> <span class="fl">25</span><span class="op">)</span> <span class="va">year</span> <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">2000</span>
         <span class="op">)</span>
<span class="co">#&gt; Warning: `copy` not specified, setting `copy=TRUE`, working on copy of table.</span>
<span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;dcmodifydb_1096926&gt; [?? x 6]</span></span>
<span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.37.2 [:memory:]</span></span>
<span class="co">#&gt;   income   age gender  year smokes cigarettes</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      0    12 M       <span style="text-decoration: underline;">2</span>020 no             10</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>      0    14 f       <span style="text-decoration: underline;">2</span>019 yes             4</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>   <span style="text-decoration: underline;">2</span>010    25 v       <span style="text-decoration: underline;">2</span>019 no             <span style="color: #BB0000;">NA</span></span></code></pre></div>
<p>Note that the corrections are made on a copy of the table by default, to avoid accidents with the data.</p>
<p>A better approach than directly applying corrections is to store the rules in a <code>modifier</code> object and apply them in a separate step to a data base table.</p>
<p>This makes it easier to maintain, use and document a set of rules. With <code>dcmodify</code> one can specify rules with the function <code>modifier</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># separate rule set</span>
<span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dcmodify/man/modifier.html" class="external-link">modifier</a></span><span class="op">(</span> <span class="kw">if</span> <span class="op">(</span><span class="va">age</span> <span class="op">&lt;</span> <span class="fl">16</span><span class="op">)</span> <span class="va">income</span> <span class="op">=</span> <span class="fl">0</span>
             , <span class="kw">if</span> <span class="op">(</span><span class="va">year</span> <span class="op">&lt;</span> <span class="fl">25</span><span class="op">)</span> <span class="va">year</span> <span class="op">=</span> <span class="va">year</span> <span class="op">+</span> <span class="fl">2000</span>
             , <span class="kw">if</span> <span class="op">(</span><span class="va">cigarettes</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">)</span> <span class="va">smokes</span> <span class="op">=</span> <span class="st">"yes"</span>
             , <span class="kw">if</span> <span class="op">(</span><span class="va">smokes</span> <span class="op">==</span> <span class="st">"no"</span><span class="op">)</span> <span class="va">cigarettes</span> <span class="op">=</span> <span class="fl">0</span>
             , <span class="va">ageclass</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">age</span> <span class="op">&lt;</span> <span class="fl">18</span><span class="op">)</span> <span class="st">"child"</span> <span class="kw">else</span> <span class="st">"adult"</span>
             , <span class="va">gender</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span>
                               , <span class="st">"F"</span> <span class="op">=</span> <span class="st">"F"</span>
                               , <span class="st">"V"</span> <span class="op">=</span> <span class="st">"F"</span> <span class="co"># common mistake</span>
                               , <span class="st">"M"</span> <span class="op">=</span> <span class="st">"M"</span>
                               , <span class="st">"NB"</span>
                               <span class="op">)</span>
             <span class="op">)</span></code></pre></div>
<p><code>m</code> is now a set of rules that can be applied to a <code>data.frame</code> or <code>tbl</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>
<span class="co">#&gt; Object of class modifier with 6 elements:</span>
<span class="co">#&gt; M1: </span>
<span class="co">#&gt;   if (age &lt; 16) income = 0</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; M2: </span>
<span class="co">#&gt;   if (year &lt; 25) year = year + 2000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; M3: </span>
<span class="co">#&gt;   if (cigarettes &gt; 0) smokes = "yes"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; M4: </span>
<span class="co">#&gt;   if (smokes == "no") cigarettes = 0</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; M5: </span>
<span class="co">#&gt;   ageclass &lt;- if (age &lt; 18) "child" else "adult"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; M6: </span>
<span class="co">#&gt;   gender &lt;- switch(toupper(gender), F = "F", V = "F", M = "M", "NB")</span></code></pre></div>
<ul>
<li><p>M3 corrects <code>smokes</code> is “no” for persons who smoke cigarettes.</p></li>
<li><p>M4 sets an unknown <code>cigarettes</code> to zero for non-smokers.</p></li>
<li><p>M5 shows an example of deriving a new variable (<code>ageclass</code>) from existing variables (<code>age</code>).</p></li>
<li><p>M6 shows an example of recoding, changing labels of categories to the allowed set of labels.</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># modify a copy of the table</span>
<span class="fu"><a href="https://rdrr.io/pkg/dcmodify/man/modify.html" class="external-link">modify</a></span><span class="op">(</span><span class="va">person_tbl</span>, <span class="va">m</span>, copy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;dcmodifydb_7690233&gt; [?? x 7]</span></span>
<span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.37.2 [:memory:]</span></span>
<span class="co">#&gt;   income   age gender  year smokes cigarettes ageclass</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      0    12 M       <span style="text-decoration: underline;">2</span>020 yes            10 child   </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>      0    14 F       <span style="text-decoration: underline;">2</span>019 yes             4 child   </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>   <span style="text-decoration: underline;">2</span>010    25 F       <span style="text-decoration: underline;">2</span>019 no              0 adult</span></code></pre></div>
<p>Note that the rules are executed sequentially, in the order that they are gven. For example the order of rule M3 and M4 matters: Rule M3 will change record 1 to a smoker, while rule M4 would set the number of cigarettes to 0. This is intentional: correction rules often have an order in which they have to be applied.</p>
<p>A nice properties of <code>modifier</code> rules, is that they can store extra metadata. They have a <code>name</code>, <code>label</code> and <code>description</code> that can be used to describe the intention and the why of a rule. An easy way of describing these properties is by exporting the ruleset to yaml and specify the rules using the yaml file.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/validate/man/export_yaml.html" class="external-link">export_yaml</a></span><span class="op">(</span><span class="va">m</span>, <span class="st">"corrections.yml"</span><span class="op">)</span></code></pre></div>
<p>In the export yml file we can label and describe the rules, but also add new rules. Note that label and description are optional, but very much encouraged.</p>
<p><em>corrections.yml</em></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1"></a></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">rules</span><span class="kw">:</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="kw">-</span><span class="at"> </span><span class="fu">expr</span><span class="kw">:</span><span class="at"> if (age &lt; 16) income = 0</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> M1</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="at">  </span><span class="fu">label</span><span class="kw">:</span><span class="at"> </span><span class="st">'nochildlabor'</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">'Children are not allowed to work, so can not have income.'</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="kw">-</span><span class="at"> </span><span class="fu">expr</span><span class="kw">:</span><span class="at"> if (year &lt; 25) year = year + 2000</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> M2</span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="at">  </span><span class="fu">label</span><span class="kw">:</span><span class="at"> </span><span class="st">'longyear'</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">'Convert 2 digits year into 4 digits.'</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="kw">-</span><span class="at"> </span><span class="fu">expr</span><span class="kw">:</span><span class="at"> if (cigarettes &gt; 0) smokes = "yes"</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> M3</span></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="at">  </span><span class="fu">label</span><span class="kw">:</span><span class="at"> </span><span class="st">'smoker'</span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">'If you smoke cigarettes you are a smoker...'</span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="kw">-</span><span class="at"> </span><span class="fu">expr</span><span class="kw">:</span><span class="at"> if (smokes == "no") cigarettes = 0</span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> M4</span></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="at">  </span><span class="fu">label</span><span class="kw">:</span><span class="at"> </span><span class="st">'nosmoke'</span></span>
<span id="cb10-18"><a href="#cb10-18"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">'If you dont smoke, the (unknown) number of cigarettes is zero'</span></span>
<span id="cb10-19"><a href="#cb10-19"></a><span class="kw">-</span><span class="at"> </span><span class="fu">expr</span><span class="kw">:</span><span class="at"> ageclass &lt;- if (age &lt; 18) "child" else "adult"</span></span>
<span id="cb10-20"><a href="#cb10-20"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> M5</span></span>
<span id="cb10-21"><a href="#cb10-21"></a><span class="at">  </span><span class="fu">label</span><span class="kw">:</span><span class="at"> </span><span class="st">'ageclass'</span></span>
<span id="cb10-22"><a href="#cb10-22"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">'Derive ageclass using the age variable'</span></span>
<span id="cb10-23"><a href="#cb10-23"></a><span class="kw">- </span><span class="fu">expr</span><span class="kw">:</span><span class="at"> </span><span class="ch">|</span></span>
<span id="cb10-24"><a href="#cb10-24"></a>    gender &lt;- switch( toupper(gender)</span>
<span id="cb10-25"><a href="#cb10-25"></a>                    , F = "F"</span>
<span id="cb10-26"><a href="#cb10-26"></a>                    , V = "F"</span>
<span id="cb10-27"><a href="#cb10-27"></a>                    , M = "M"</span>
<span id="cb10-28"><a href="#cb10-28"></a>                    , "NB"</span>
<span id="cb10-29"><a href="#cb10-29"></a>                    )</span>
<span id="cb10-30"><a href="#cb10-30"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> M6</span></span>
<span id="cb10-31"><a href="#cb10-31"></a><span class="at">  </span><span class="fu">label</span><span class="kw">:</span><span class="at"> </span><span class="st">'gender'</span></span>
<span id="cb10-32"><a href="#cb10-32"></a><span class="at">  </span><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">'Map the labels for gender to M/F/NB'</span></span></code></pre></div>
<p>We can load these rules with:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dcmodify/man/modifier.html" class="external-link">modifier</a></span><span class="op">(</span>.file <span class="op">=</span> <span class="st">"corrections.yml"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/dcmodify/man/modify.html" class="external-link">modify</a></span><span class="op">(</span><span class="va">person_tbl</span>, <span class="va">m</span>, copy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;dcmodifydb_7177690&gt; [?? x 7]</span></span>
<span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.37.2 [:memory:]</span></span>
<span class="co">#&gt;   income   age gender  year smokes cigarettes ageclass</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      0    12 M       <span style="text-decoration: underline;">2</span>020 yes            10 child   </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>      0    14 F       <span style="text-decoration: underline;">2</span>019 yes             4 child   </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>   <span style="text-decoration: underline;">2</span>010    25 F       <span style="text-decoration: underline;">2</span>019 no              0 adult</span></code></pre>
<p><code>modify</code> translates the modification rules into SQL code and executes the sql queries on the database. For documentation or implementation purpose it can be useful to see the generated sql code, with the documented rules.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/dump_sql.html">dump_sql</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">person_tbl</span>, file <span class="op">=</span> <span class="st">"corrections.sql"</span><span class="op">)</span></code></pre></div>
<p><em>corrections.sql</em>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1"></a><span class="co">-- -------------------------------------</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="co">-- Generated with dcmodifydb, do not edit</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="co">-- dcmodify version: 0.1.9</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="co">-- dcmodifydb version: 0.3.0.9001</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="co">-- dplyr version: 1.0.8</span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="co">-- dbplyr version: 2.1.1</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="co">-- from: '/Users/runner/work/_temp/Library/dcmodifydb/db/corrections.yml'</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="co">-- date: 2022-03-21</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co">-- -------------------------------------</span></span>
<span id="cb14-10"><a href="#cb14-10"></a></span>
<span id="cb14-11"><a href="#cb14-11"></a></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> `person`</span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="kw">ADD</span> `ageclass` TEXT;</span>
<span id="cb14-14"><a href="#cb14-14"></a></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="co">-- M1: nochildlabor</span></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="co">-- Children are not allowed to work, so can not have income.</span></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="co">-- R expression: if (age &lt; 16) income = 0</span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="kw">UPDATE</span> `person`</span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="kw">SET</span> `income` <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb14-20"><a href="#cb14-20"></a><span class="kw">WHERE</span> `age` <span class="op">&lt;</span> <span class="fl">16.0</span>;</span>
<span id="cb14-21"><a href="#cb14-21"></a></span>
<span id="cb14-22"><a href="#cb14-22"></a><span class="co">-- M2: longyear</span></span>
<span id="cb14-23"><a href="#cb14-23"></a><span class="co">-- Convert 2 digits year into 4 digits.</span></span>
<span id="cb14-24"><a href="#cb14-24"></a><span class="co">-- R expression: if (year &lt; 25) year = year + 2000</span></span>
<span id="cb14-25"><a href="#cb14-25"></a><span class="kw">UPDATE</span> `person`</span>
<span id="cb14-26"><a href="#cb14-26"></a><span class="kw">SET</span> `year` <span class="op">=</span> `year` <span class="op">+</span> <span class="fl">2000.0</span></span>
<span id="cb14-27"><a href="#cb14-27"></a><span class="kw">WHERE</span> `year` <span class="op">&lt;</span> <span class="fl">25.0</span>;</span>
<span id="cb14-28"><a href="#cb14-28"></a></span>
<span id="cb14-29"><a href="#cb14-29"></a><span class="co">-- M3: smoker</span></span>
<span id="cb14-30"><a href="#cb14-30"></a><span class="co">-- If you smoke cigarettes you are a smoker...</span></span>
<span id="cb14-31"><a href="#cb14-31"></a><span class="co">-- R expression: if (cigarettes &gt; 0) smokes = "yes"</span></span>
<span id="cb14-32"><a href="#cb14-32"></a><span class="kw">UPDATE</span> `person`</span>
<span id="cb14-33"><a href="#cb14-33"></a><span class="kw">SET</span> `smokes` <span class="op">=</span> <span class="st">'yes'</span></span>
<span id="cb14-34"><a href="#cb14-34"></a><span class="kw">WHERE</span> `cigarettes` <span class="op">&gt;</span> <span class="fl">0.0</span>;</span>
<span id="cb14-35"><a href="#cb14-35"></a></span>
<span id="cb14-36"><a href="#cb14-36"></a><span class="co">-- M4: nosmoke</span></span>
<span id="cb14-37"><a href="#cb14-37"></a><span class="co">-- If you dont smoke, the (unknown) number of cigarettes is zero</span></span>
<span id="cb14-38"><a href="#cb14-38"></a><span class="co">-- R expression: if (smokes == "no") cigarettes = 0</span></span>
<span id="cb14-39"><a href="#cb14-39"></a><span class="kw">UPDATE</span> `person`</span>
<span id="cb14-40"><a href="#cb14-40"></a><span class="kw">SET</span> `cigarettes` <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb14-41"><a href="#cb14-41"></a><span class="kw">WHERE</span> `smokes` <span class="op">=</span> <span class="st">'no'</span>;</span>
<span id="cb14-42"><a href="#cb14-42"></a></span>
<span id="cb14-43"><a href="#cb14-43"></a><span class="co">-- M5: ageclass</span></span>
<span id="cb14-44"><a href="#cb14-44"></a><span class="co">-- Derive ageclass using the age variable</span></span>
<span id="cb14-45"><a href="#cb14-45"></a><span class="co">-- R expression: ageclass &lt;- if (age &lt; 18) "child" else "adult"</span></span>
<span id="cb14-46"><a href="#cb14-46"></a><span class="kw">UPDATE</span> `person`</span>
<span id="cb14-47"><a href="#cb14-47"></a><span class="kw">SET</span> `ageclass` <span class="op">=</span> <span class="st">'child'</span></span>
<span id="cb14-48"><a href="#cb14-48"></a><span class="kw">WHERE</span> `age` <span class="op">&lt;</span> <span class="fl">18.0</span>;</span>
<span id="cb14-49"><a href="#cb14-49"></a></span>
<span id="cb14-50"><a href="#cb14-50"></a><span class="kw">UPDATE</span> `person`</span>
<span id="cb14-51"><a href="#cb14-51"></a><span class="kw">SET</span> `ageclass` <span class="op">=</span> <span class="st">'adult'</span></span>
<span id="cb14-52"><a href="#cb14-52"></a><span class="kw">WHERE</span> <span class="kw">NOT</span>(`age` <span class="op">&lt;</span> <span class="fl">18.0</span>);</span>
<span id="cb14-53"><a href="#cb14-53"></a></span>
<span id="cb14-54"><a href="#cb14-54"></a><span class="co">-- M6: gender</span></span>
<span id="cb14-55"><a href="#cb14-55"></a><span class="co">-- Map the labels for gender to M/F/NB</span></span>
<span id="cb14-56"><a href="#cb14-56"></a><span class="co">-- R expression: gender &lt;- switch(toupper(gender), F = "F", V = "F", M = "M", "NB")</span></span>
<span id="cb14-57"><a href="#cb14-57"></a><span class="kw">UPDATE</span> `person`</span>
<span id="cb14-58"><a href="#cb14-58"></a><span class="kw">SET</span> `gender` <span class="op">=</span> <span class="cf">CASE</span> <span class="fu">UPPER</span>(`gender`) <span class="cf">WHEN</span> (<span class="st">'F'</span>) <span class="cf">THEN</span> (<span class="st">'F'</span>) <span class="cf">WHEN</span> (<span class="st">'V'</span>) <span class="cf">THEN</span> (<span class="st">'F'</span>) <span class="cf">WHEN</span> (<span class="st">'M'</span>) <span class="cf">THEN</span> (<span class="st">'M'</span>) <span class="cf">ELSE</span> (<span class="st">'NB'</span>) <span class="cf">END</span></span>
<span id="cb14-59"><a href="#cb14-59"></a>;</span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Edwin de Jonge.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
